<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="../css/examples.css">
		<style type="text/css">
			liaison-example-loan {
				position: absolute;
			}
			.error-message {
				color: red;
			}
		</style>
		<script type="text/javascript" src="../../../dojo/dojo.js" data-dojo-config="async: 1"></script>
		<script id="loan-template" type="text/x-template">
			<div>
				<h2>Borrower information</h2>
				<div><span class="cell">Name:</span> <input type="text" value="{{Name}}"></div>
				<h2>Expenses</h2>
				<div><span class="cell">Mortgage:</span> <input type="text" value="{{number:Mortgage}}"></div>
				<div><span class="cell">Real Estate Taxes:</span> <input type="text" value="{{number:Taxes}}"></div>
				<div><span class="cell">Other Housing:</span> <input type="text" value="{{number:OtherHousing}}"></div>
				<div><span class="cell">Total Housing:</span> <input type="text" value="{{number:TotalHousing}}"></div>
				<h2>Income</h2>
				<div><span class="cell">Base Income:</span> <input type="text" value="{{number:BaseIncome}}"></div>
				<div><span class="cell">Bonus Income:</span> <input type="text" value="{{number:BonusIncome}}"></div>
				<div><span class="cell">Total Income:</span> <input type="text" value="{{number:TotalIncome}}"></div>
				<h2>Analysis</h2>
				<div><span class="cell">Percent Housing (Under 33%):</span> <input type="text" disabled="{{HousingPercentDisabled}}" value="{{number:HousingPercent}}"> <span class="error-message">{{HousingPercentError}}</span></div>
			</div>
		</script>
		<script type="text/javascript">
			require([
				"dcl/dcl",
				"delite/register",
				"delite/Widget",
				"liaison/ObservablePath",
				"liaison/BindingSourceList",
				"liaison/delite/createRenderer",
				"dojox/charting/Chart",
				"dojox/charting/themes/PlotKit/blue",
				"liaison/DOMTreeBindingTarget",
				"dojox/charting/plot2d/Pie"
			], function(dcl, register, Widget, ObservablePath, BindingSourceList, createRenderer, Chart, blue){
				var BindingSourceSeries = (function(){
					function setDataAndPushChanges(value){
						this.data = value;
						if(this.series){
							this.series.chart.updateSeries(this.series.name, this);
							this.series.chart.delayedRender();
						}
					}
					return function(source){
						this.setSeriesObject = function(series){
							this.series = series;
						};
						this.destroy = function(){
							if(h){ h.remove(); h = null; }
						};
						var h = source.observe(setDataAndPushChanges.bind(this));
						setDataAndPushChanges.call(this, source.getFrom());
					};
				})();

				function startup () {
					var REGEXP_NUMBER_BINDING = /^number:(.*)$/;
					register("liaison-example-loan", [HTMLElement, Widget], {
						buildRendering: createRenderer(document.getElementById("loan-template").innerHTML),
						baseClass: "liaison-example-loan",
						Name: "John Doe",
						BaseIncome: 50000,
						BonusIncome: 10000,
						Mortgage: 1000,
						Taxes: 500,
						OtherHousing: 1200,
						isZipValid: true,
						createBindingSourceFactory: function(target) {
							var match = REGEXP_NUMBER_BINDING.exec(target);
							if(match){
								var path = match[1];
								return function(model){
									return new ObservablePath(model, path, function(value){
										return value + "";
									}, function(value){
										return +value;
									});
								}
							}
						},
						createdCallback: dcl.superCall(function (sup) {
							return function(){
								this.TotalHousing = new BindingSourceList([
									new ObservablePath(this, "Mortgage"),
									new ObservablePath(this, "Taxes"),
									new ObservablePath(this, "OtherHousing")
								], function(a){
									return a[0] + a[1] + a[2];
								});
								this.TotalIncome = new BindingSourceList([
									new ObservablePath(this, "BaseIncome"),
									new ObservablePath(this, "BonusIncome")
								], function(a){
									return a[0] + a[1];
								});
								this.HousingPercent = new BindingSourceList([
									new ObservablePath(this, "TotalHousing"),
									new ObservablePath(this, "TotalIncome")
								], function(a){
									return Math.round(a[0] / a[1] * 100);
								});
								this.HousingPercentError = new ObservablePath(this, "HousingPercent", function(housingPercent){
									return housingPercent > 33 ? "Housing should be less than 1/3 total expenses!" : "";
								});
								this.HousingPercentDisabled = new ObservablePath(this, "HousingPercent", function(housingPercent){
									return housingPercent <= 0 ? "disabled" : null;
								});
								sup && sup.apply(this, arguments);
							};
						})
					});
					register.parse();
					var model = document.querySelector("liaison-example-loan"),
						source = new BindingSourceList([
							new ObservablePath(model, "Mortgage"),
							new ObservablePath(model, "Taxes"),
							new ObservablePath(model, "OtherHousing")
						]);
					new Chart("chart")
					 .setTheme(blue)
					 .addPlot("default", {type: "Pie"})
					 .addSeries("default", new BindingSourceSeries(source)).render();
				}

				document.body ? startup() : window.addEventListener("DOMContentLoaded", startup);
			});
		</script>
	</head>
	<body>
		<liaison-example-loan></liaison-example-loan>
		<div id="chart" style="position:absolute;left:400px;width:150px;height:150px;"></div>
	</body>
</html>
